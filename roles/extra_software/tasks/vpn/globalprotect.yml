---

- name: "[GLOBALPROTECT] install package"
  pacman:
    name: globalprotect-openconnect=1.4.9-2
    state: present
    update_cache: true
  when: linux_distribution == 'arch'

- become: false
  when: linux_distribution != 'arch'
  block:
    - name: "[GLOBALPROTECT] uncompress globalprotect package"
      unarchive:
        src: "{{ globalprotect_package }}"
        dest: /tmp
        remote_src: true
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: "[GLOBALPROTECT] fix wget argument"
      replace:
        path: /tmp/globalprotect-openconnect-1.4.9/cmakew
        regexp: "wget -nv --show-progress "
        replace: "wget -nv "
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: "[GLOBALPROTECT] execute installation script"
      shell: "./scripts/install-{{ linux_distribution }}.sh"
      args:
        chdir: "/tmp/globalprotect-openconnect-1.4.9"
      ignore_errors: true
      register: command_response

    - name: "[GLOBALPROTECT] delete temporal files"
      become: true
      file:
        path: "/tmp/globalprotect-openconnect-1.4.9"
        state: absent
      when: command_response.changed and not command_response.failed

- when: desktop_environment == "gnome"
  vars:
    icon_path: /var/tmp/globalprotect/icon
  tags:
    - globalprotect_icon
  block:
    - name: "[GLOBALPROTECT] create directory"
      file:
        path: "{{ icon_path }}"
        state: directory

    - name: "[GLOBALPROTECT] copy icon"
      copy:
        src: vpn-icon.png
        dest: "{{ icon_path }}/globalprotect.png"
        owner: root
        group: root

    - name: "[GLOBALPROTECT] edit application icon"
      lineinfile:
        path: "/usr/share/applications/com.yuezk.qt.gpclient.desktop"
        regexp: "^Icon="
        line: "Icon={{ icon_path }}/globalprotect.png"
