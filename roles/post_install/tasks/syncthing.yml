# ---

- name: "[SYNCTHING] get device id"
  xml:
    path: "/home/{{ ansible_user }}/.config/syncthing/config.xml"
    xpath: /configuration/device
    content: attribute
  register: xml_response1

- name: "[SYNCTHING] get api key"
  xml:
    path: "/home/{{ ansible_user }}/.config/syncthing/config.xml"
    xpath: /configuration/gui/apikey
    content: text
  register: xml_response2

- name: "[SYNCTHING] set syncthing variables"
  set_fact:
    syncthing_device_id: "{{ xml_response1.matches[0].device.id }}"
    syncthing_apikey: "{{ xml_response2.matches[0].apikey }}"

- name: "[SYNCTHING] get current config"
  uri:
    url: http://localhost:8384/rest/config
    headers:
      X-API-Key: "{{ syncthing_apikey }}"
    return_content: true
  register: syncthing_config

- name: "[SYNCTHING] set syncthing old config"
  set_fact:
    syncthing_old_config: "{{ syncthing_config.json }}"


# - name: "[SYNCTHING] get system config"
#   uri:
#     url: "http://127.0.0.1:8384/rest/system/config"
#     return_content: true
#     headers:
#       X-API-Key: "{{ syncthing_apikey }}"
#   register: syncthing_config_raw
#   check_mode: false

# - name: "[SYNCTHING] post config"
#   uri:
#     url: "http://127.0.0.1:8384/rest/system/config"
#     method: POST
#     return_content: true
#     headers:
#       Content-Type: "application/json"
#       X-API-Key: "{{ syncthing_apikey }}"
#     body: "{{ syncthing_config | to_json }}"
#     body_format: "json"
#   when: syncthing_config != syncthing_config_old

# - name: "[SYNCTHING] syncthing restart"
#   uri:
#     url: "http://127.0.0.1:8384/rest/system/restart"
#     method: POST
#     return_content: true
#     headers:
#       X-API-Key: "{{ syncthing_apikey }}"
#   when: syncthing_config != syncthing_config_old

# ## vim: foldmethod=marker:tabstop=2:shiftwidth=2:softtabstop=2
