---

- name: "[LOAD VARS] setting ansible variables"
  import_playbook: playbooks/load_distro_vars.yml
  tags:
    - always

- hosts: localhost
  connection: local
  tasks:
    - name: "[PREPARE] check if prepare flag exists"
      stat:
        path: /var/tmp/.prepare
      register: prepare_response

    - set_fact:
        prepare_exists: "{{ prepare_response.stat.exists }}"
  tags:
    - always

- name: "[PREPARE] setting ansible variables"
  import_playbook: playbooks/load_distro_vars.yml
  when:
    - hostvars['localhost'][ 'prepare_exists'] | bool
    - linux_distribution in ["debian", "ubuntu"]
  tags:
    - always

###############
# INSTALACION #
###############

- hosts: localhost
  connection: local
  become: true
  become_method: sudo
  vars:
    disable_updates: "{{ lookup('env', 'REPO_DISABLE_UPDATES') | default(false) | bool }}"
    ansible_user: "{{ lookup('env', 'USER') }}"
    ansible_user_dir: "/home/{{ lookup('env', 'USER') }}"
    op:
      host: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        61643763313333366438373066653336343764316437626436306562323434636336323533323837
        6335353234376635633963383663303138393936376265660a366336336431386630653164363533
        36363261653966383133633633636638353364613561383534643261633766653735356536643338
        3232313435633339390a663061396432363962333934396437626238396239363539353664353832
        3664
      user: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        63383562373935356634613266393830306466613030323965643966616232663031313866633632
        6163353035323663356462306632663766303237666465380a356166653865633437303561333235
        36643761633030666435646332343731333635373335323435663664383533396664663731653033
        6463663034373332350a636664313262386466343863616434306532326139303939653234633230
        37613661353637666437313530666562613438663363663630306535613563633761
      sk: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        37613462613465373732616135393939313639393264373935646461383031383735616234663233
        6632326461383862633038626261383135383566373431300a666162633139616363656137613338
        66363964653762633263383738353436333566333032313239663931353537636632626262643139
        3931613231623030300a636238666438306230303733643637383930343330616437383463613236
        62636661316234393138313230643565616531336233353233393665623266393863643932363937
        3935656237663234386234616538353034346661653965313133
      doc1: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        37613534343363373731653863323339356161646564613634636136363436666365666132666336
        3763396236626331343132303863313161366531636261660a313361373636323063363536373930
        35393134306365386365656637396131336335323233393033373366656234643033616565323533
        6565666538316434380a323966643164393334653231353733616438636164623033643737663137
        66366435653434376561383862353663366164616261613666336632633635653965
      doc2: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        32636633323863386631366530663639653965396139623463636538323533343632373861326562
        3630366432333336313262663834313662383433623637390a373039363139336331633432653764
        63636136383334316336303365623436386231303663333138646630663063343439313738653161
        6163366662616461640a356332643438636162363138613537373239323531323561333963623766
        64303232616234303231396164313832373332303961666463313861646234666166
      file1: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        32653534386138623866663161376335343662643361613866343234356364373062613533306534
        6436363736323733626262313935363666656532346235660a643738613364353931353534343866
        61326238346262333866306137306666313264613437633663366535306537656264386339643132
        3837333037623763650a383332323533653930313535643465643565303261626266646236353138
        3230
      file2: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        65316266366631343737323561643831613564646430656636663364363935346365306363353331
        3630363634323537663361303039383465343665323037620a636337643139343866666138386365
        39356637323661626331353835663865613530393939633931306564383139326565346634663638
        6537643462343939650a363665653336313835323136313963643533323730633136346231363862
        3439
      item1: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        61656539636132626562643363656664376165613436666163653564356539326236373664666137
        3639623538643331623265373432306434323062643461650a393862353066396365323763643336
        61363636653764373362383965343434643136643864303166353535616563366635656261393362
        3034303230313234350a303832666433633731343161303462326265636238323661323138323561
        30326238666233316533303238336437323861626264363731636233383766323431
  roles:
    - common
    - extra_software
  post_tasks:
    # - become: false
    #   block:
    #     - name: "check that git hooks exist"
    #       stat:
    #         path: "{{ playbook_dir }}/.git/hooks/post_merge"
    #       register: stat_response


    #     - name: "copy git hook scripts"
    #       template:
    #         src: roles/post_install/templates/post-merge.j2
    #         dest: "{{ playbook_dir }}/.git/hooks/post-merge"
    #         owner: "{{ ansible_user }}"
    #         group: "{{ ansible_user }}"
    #         mode: 0755
    #       when: not stat_response.stat.exists

    #     - name: "creating link for hook 'post-rewrite'"
    #       file:
    #         src: "{{ playbook_dir }}/.git/hooks/post-merge"
    #         dest: "{{ playbook_dir }}/.git/hooks/post-rewrite"
    #         state: link
    #       when: not stat_response.stat.exists
    #   tags:
    #     - git_hooks
    #     - always

    - become: false
      block:
        - stat:
            path: /usr/local/bin/op
          register: op_response

        - name: "Generating the script './prepare_post.sh'"
          template:
            src: roles/post_install/templates/prepare_post.sh.j2
            dest: "./prepare_post.sh"
            mode: 0755
          when: op_response.stat.exists

        - debug:
            msg: "Please, execute: './prepare_post.sh'"
      tags:
        - prepare_post
        - always
