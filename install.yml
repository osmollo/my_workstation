---

- name: "[LOAD VARS] setting ansible variables"
  import_playbook: playbooks/load_distro_vars.yml
  tags:
    - always

###############
# INSTALACION #
###############

- hosts: localhost
  connection: local
  become: true
  become_method: sudo
  vars:
    disable_updates: "{{ lookup('env', 'REPO_DISABLE_UPDATES') | default(false) | bool }}"
    ansible_user: "{{ lookup('env', 'USER') }}"
    ansible_user_dir: "/home/{{ lookup('env', 'USER') }}"
  roles:
    - common
    - extra_software
  post_tasks:
    - become: false
      block:
        - name: "include secrets file"
          include_vars:
            file: roles/post_install/vars/secrets.yml

        - name: "Check if bitwarden-cli is installed"
          stat:
            path: /usr/local/bin/bw
          register: bw_response

        - name: "Generating the script './prepare_post.sh'"
          template:
            src: roles/post_install/templates/prepare_post.sh.j2
            dest: "./prepare_post.sh"
            mode: 0755
          when: bw_response.stat.exists

        - name: "[UBUNTU PRO] generate script"
          template:
            src: roles/post_install/templates/ubuntu_pro.sh.j2
            dest: "./ubuntu_pro.sh"
            mode: 0755
          when: ansible_distribution == 'Ubuntu'

        - name: "Final step"
          debug:
            msg: "Please, execute: './prepare_post.sh'"
      when: ansible_user in ['ohermosa', 'osmollo', 'yosmollo']
      tags:
        - prepare_post
        - always
